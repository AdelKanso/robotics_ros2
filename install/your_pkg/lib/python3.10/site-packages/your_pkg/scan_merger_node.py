#!/usr/bin/env python3
import rclpy
from rclpy.node import Node
from sensor_msgs.msg import LaserScan
from tf2_ros import Buffer, TransformListener
import numpy as np

class ScanMerger(Node):
    def __init__(self):
        super().__init__('scan_merger')
        self.scan_sub = self.create_subscription(LaserScan, '/scan', self.lidar_callback, 10)
        self.vline_sub = self.create_subscription(LaserScan, '/virtual_line_scan', self.vline_callback, 10)
        self.merged_pub = self.create_publisher(LaserScan, '/merged_scan', 10)

        self.lidar_scan = None
        self.vline_scan = None
        self.tf_buffer = Buffer()
        self.tf_listener = TransformListener(self.tf_buffer, self)

        self.timer = self.create_timer(0.1, self.merge_callback)  # 10 Hz

        # Merger params (tune if needed)
        self.angle_min = -np.pi
        self.angle_max = np.pi
        self.angle_increment = 0.0058  # ~0.33 deg, matches TurtleBot3 LDS-01
        self.range_min = 0.01
        self.range_max = 3.5  # LiDAR max

    def lidar_callback(self, msg):
        self.lidar_scan = msg

    def vline_callback(self, msg):
        self.vline_scan = msg

    def merge_callback(self):
        if self.lidar_scan is None or self.vline_scan is None:
            return

        # Create angle bins for merged scan
        num_bins = int((self.angle_max - self.angle_min) / self.angle_increment) + 1
        merged_ranges = [self.range_max] * num_bins

        # Helper to add scan to merged
        def add_scan(scan_msg, ranges):
            for i, r in enumerate(scan_msg.ranges):
                angle = scan_msg.angle_min + i * scan_msg.angle_increment
                # Normalize angle to [-pi, pi]
                angle = (angle + np.pi) % (2 * np.pi) - np.pi
                bin_idx = int((angle - self.angle_min) / self.angle_increment)
                if 0 <= bin_idx < len(ranges):
                    ranges[bin_idx] = min(ranges[bin_idx], r)

        add_scan(self.lidar_scan, merged_ranges)
        add_scan(self.vline_scan, merged_ranges)

        # Publish merged
        merged = LaserScan()
        merged.header = self.lidar_scan.header  # Use LiDAR timestamp/frame
        merged.header.frame_id = 'base_scan'
        merged.angle_min = self.angle_min
        merged.angle_max = self.angle_max
        merged.angle_increment = self.angle_increment
        merged.time_increment = self.lidar_scan.time_increment
        merged.scan_time = self.lidar_scan.scan_time
        merged.range_min = self.range_min
        merged.range_max = self.range_max
        merged.ranges = merged_ranges
        self.merged_pub.publish(merged)

        self.get_logger().info(f'Merged scan published: {len(merged_ranges)} rays')

def main():
    rclpy.init()
    node = ScanMerger()
    rclpy.spin(node)
    node.destroy_node()
    rclpy.shutdown()

if __name__ == '__main__':
    main()