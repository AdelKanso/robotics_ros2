#!/usr/bin/env python3
import rclpy
from rclpy.node import Node
import tf2_ros
from math import atan2
import csv
import os

class TFLogger(Node):
    def __init__(self):
        super().__init__('tf_pose_logger')

        # Declare ROS2 parameter for CSV path
        self.declare_parameter('csv_path', '/home/masters/robot_xy_yaw.csv')
        csv_path = self.get_parameter('csv_path').get_parameter_value().string_value

        # Expand ~ if user provides it
        csv_path = os.path.expanduser(csv_path)

        # Ensure folder exists
        os.makedirs(os.path.dirname(csv_path), exist_ok=True)

        # Open CSV file
        self.csv_file = csv_path
        self.file = open(self.csv_file, 'w', newline='')
        self.writer = csv.writer(self.file)
        self.writer.writerow(['time', 'x', 'y', 'yaw'])

        self.get_logger().info(f"Saving robot position to: {self.csv_file}")

        # TF listener
        self.buffer = tf2_ros.Buffer()
        self.listener = tf2_ros.TransformListener(self.buffer, self)

        # Timer for logging at 10 Hz
        self.timer = self.create_timer(0.1, self.log_pose)


    def log_pose(self):
        try:
            trans = self.buffer.lookup_transform(
                'map', 'base_link', rclpy.time.Time())

            x = trans.transform.translation.x
            y = trans.transform.translation.y
            qx = trans.transform.rotation.x
            qy = trans.transform.rotation.y
            qz = trans.transform.rotation.z
            qw = trans.transform.rotation.w

            yaw = atan2(2*(qw*qz + qx*qy), 1 - 2*(qy*qy + qz*qz))

            timestamp = self.get_clock().now().nanoseconds / 1e9
            self.writer.writerow([timestamp, x, y, yaw])

        except Exception:
            pass


def main(args=None):
    rclpy.init(args=args)
    node = TFLogger()

    try:
        rclpy.spin(node)
    except KeyboardInterrupt:
        pass
    finally:
        node.file.close()
        node.destroy_node()
        rclpy.shutdown()


if __name__ == '__main__':
    main()
